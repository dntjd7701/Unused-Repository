

- 메뉴코드 : POM1020
- 설계자 : 임성환
- 개발자 : 강우성
- 작성일 : 2023-10-18

### 개발 목적 

- 모품목에 따른 자품목에 대한 모든 자재들에 한하여 모든 재고 정보를 제공한다. 
- 이 때, 사용자는 가상의 기준수량을 입력하여 그에 따른 자재들의 계산된 재고 정보를 확인할 수 있다. 

### 개발 주의 사항 

- 설계 상에 이전 시스템의 프로시저를 분석하여 작성하라고 기입되어 있으나, 현재 테이블 및 프로세스가 변경되어 주의가 필요하다. ( ex) 재공: (이전) 실적 등록 시, (현재) 지시 확정 시)
- 많은 테이블의 조인이 이루어짐으로, 쿼리 작성 시 튜닝에 주의한다.
- 화면 개발 시, 합의된 동작에 따라 이루어질 수 있도록 주의한다. 
- 트리구조-일반그리드 스위칭 구조 : 예를 들어 조회조건에 계정구분이 걸려있을 경우, 특정 레벨만 해당 조회조건에 해당되게 된다면 이는 트리로 나타내기에 애매한 부분이 존재함으로. 설계팀과의 협의를 통해 이러한 조회조건(계정구분, 조달구분, 과부족..) 이 걸려있을 경우 일반그리드로, 그게 아닐 경우 트리구조로 나타내도록 한다. 

### 개발 참고 사항 

> 주문 -> 지시 -> 실적 -> 입고 -> 출고 -> 마감 

> ==**재공**==
> 재공은 생산 중인 물품까지 포괄한 개념으로, 현 프로세스에서는 지시가 확정되었을 경우 재공으로 취급된다. (ICube의 경우 실적이 발생했을 경우, 재공으로 인정)

> ==각 컬럼별 누계 화면 ==
	전개기준의 모품목 현재고 반영/미반영 : 현재 조회를 원하는 기준수량 값에 가지고 있는 가용재고(현재고) 수량을 반영하냐 반영하지 않냐를 결정한다. 
	예를들어 사용자가 10개의 기준수량을 입력했을 때, 현재고가 5개이고 현재고를 반영한다고 선택할 경우. 10 - 5 = 5개의 수량값을 기준으로 데이터를 산정한다.
	---
> 주생산계획현황(MPS)를 기반으로하여 프로세스를 적용해도 무관 
>-  단위소요량 : BOM등록 메뉴의 필요수량
>-  필요수량 : 조회조건에 기준수량 * 단위소요량
>-  재고수량 : 현재고현황(사업장)별 재고수량
>-  재공수량 : 현재공현황(사업장)별 재공수량
>- 구매입고예정량 : 발주미납현황 메뉴에 발주미납수량 (재고단위수량)
>
>- 생산입고예정량 : 작업지시등록 메뉴에 작업지시수량(지시확정수량) - 작업실적등록 메뉴에 작업실적수량 
	(LPROD, LWORK) 이때, 실적수량은 최종공정값으로 산출한다.(LAST_YN = '1')

>- 외주입고예정량 : 외주발주등록 메뉴에서 외주구분에 따라, 공정과 품목이 나뉘는데 둘의 계산을 각각 구하여 합해야 한다. 먼저, 품목의 경우  외주발주수량 - 외주실적등록 메뉴에 외주실적수량이고, 공정의 경우 다공정일 때, 첫번째 공정(최종공정 ?)을 기준으로 구하여 더한다.
>  (외주입고의 경우, 품목외주를 기준으로만 산출한다. -외주출고등록,  공정외주의 경우 생산출고로 같이 합산되기 때문에 품목외주만 별도로 구하여 합한다.)
>
>- 주문출고예정량 : 주문미납현황 메뉴에 주문미납수량(재고단위수량)
>- 자재할당량 : 생산과 외주를 각각 구하여 합해야 한다. 생산의 경우 생산지시확정수량에 생산출고등록 화면의 출고수량을 차감한다.(이때, 다공정일 경우에는 1번 공정으로 선택한다.)
>  여기에 더해 외주의 경우 공정외주는 발주처리 없이 생산자재출고가 가능함으로 지시확정수량에 자재출고수량을 차감하는 것이 중복된다. 그렇기에 공정의 경우 계산에서 제외하고, 품목외주의 경우 외주발주등록의 발주수량(사급자재 수량) 에서 외주출고등록의 출고수량값을 뺀 것이 된다. 결과적으로 두개의 구해진 값이 더해진게 자재할당량이 된다. 
>- 안전재고 : 품목등록메뉴에 안전재고
>- 가용재고 : 재고수량 + 재공수량 + 구매입고예정량 + 생산입고예정량 + 외주입고예정량 - 주문출고예정량 - 자재할당량 - 안전재고 + 상위모품목의 가용재고 * 단위소요량
>- 과부족 : 가용재고 - 필요수량


> 
>  생산입고예정량: 생산지시등록, 생산실적등록
> 	1) 지시 -> 확정 -> 실적 -> 입고
> 	2) 이 경우, 지시 수량은 대기/진행/확정 건을 가져온다. 즉, 확정된 것까지 포괄하여 가져온다.
> 	3) 입고된 건이 아닌 실적에서 처리된 건을 기준으로 예정량을 가져온다. 이는 기준에 따른 차이로 입고 처리된 건을 입고 예정량으로 바라볼지, 실적 등록된 건을 기준으로 볼지의 차이이다.(설계팀 협의에 의거 실적으로 결정)
> 	4) LPROD 의 경우 LWORK(실적)의 최종공정 값이 트리거로 들어간다. 일단 이 값을 실적수량의 기준값으로 지정하였다. 
> 	


### ! 전면 수정

1. 설계팀과 협의 결과 : 
	1) 조회조건은 해당 품목 현재고의 가용재고를 의미한다. 
	2) 그리드의 가용재고는 계산식과 동일하다
	3) 일은 더 어려워졌지만, BOM의 특성을 고려, 트리 구조로 변경하여 최하위 품목까지 전개하도록 한다. 
	4) 기존 BOM의 경우 순환참조 예방을 위해 20LEVEL을 기준으로 제한을 두었지만, BOM의 특성과 조회 시의 시간을 고려해 10LEVEL로 제한을 수정한다.



생산과 외주. 

외주의 경우 외주구분이 '공정외주' 인것과 '품목외주' 인 건으로 나뉜다.(PO_TY) 
이 때, 공정외주의 건은 생산출고를 통해서만 처리가 됨으로, 외주출고쪽에서는 품목외주건만 확인을 하면 된다.

즉, 예정량을 산출할 때에, 생산쪽에서의 계산이 공정외주를 포함함으로,  외주예정량을 산출시에는 품목외주건만 바라보도록 처리하여야한다. 