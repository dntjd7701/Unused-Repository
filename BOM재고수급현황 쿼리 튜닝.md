

### 인덱싱 

해당 화면은, 특정 품목의 BOM에 따라 각 품목의 재고를 전수 조사하여 보여주는 화면이다. 

근데 속도가 심상치 않다. 왜 느릴까 ? 조건에 걸리는 데이터를 조회해보니 총 1만건 정도의 데이터이고 이 정도로 속도가 걸릴 만한 쿼리는 아니다. 

index의 순서의 문제였나 고민했으나 그런 것은 아니였다. 

해답은 의외로 간단하고, 그 효과는 극적이였다. 

```sql 
LEFT OUTER JOIN erp_1234.LSTOCK_D LSTOCK
    ON D.CO_CD = LSTOCK.CO_CD
    AND D.PO_NB = LSTOCK.PO_NB
    AND D.PO_SQ = LSTOCK.PO_SQ
    AND D.ITEM_CD = LSTOCK.ITEM_CD
```

여기에서 'LPO_D(발주등록디테일)' 의 키값은 LSTOCK(입고등록내역)의 키값과 연결되어 있다. 

![[Pasted image 20240411151932.png]]

인덱스 또한 위와같이 걸려있었다. 다만, 간과한것이 한가지 있었다. 

인덱스가 포함된 관계, 즉 A,B,C로 인덱스가 걸려있고 A,B로 JOIN을 한 경우와, A,B가 걸려있고 A,B,C로 JOIN을 한 경우는 극적으로 성능이 갈린다는 것을 말이다. 

인덱스가 조인문을 포함할 때에는 이미 정렬이 되어있는 곳에서 뒤의 정렬을 무시함으로 인덱스의 성능 이점을 챙길 수 있으나, 그 반대의 경우에는 조인 시에 전체 테이블을 스캔하며 매칭되는 행을 찾아야 함으로 성능이 저하된다. 

그 결과 2023년도 부터 금일까지의 날짜를 조회했을 때 기본 SELECT절 기준 1만건의 데이터에 대하여

$$54,162ms -> 203ms$$
로 말도 안되는 차이가 나타났다... BP적으로 고려했을 때에도 필요없는 조인 키였음으로 필수적으로 수정해야하는 부분이였다. 

그 외, 조인 시, 전테이블의 조인키를 우선적으로 거는 것 WHERE 조건의 개선을 통해 이 전에 비해 압도적으로 나은 쿼리 속도를 보여주었다. 






여러 테이블이 조인되고 있고, JOIN 시점에 keyA, keyB에 대해 인덱스가 걸려있을 때, keyA, keyB, keyC로 JOIN을 하게 되면 어떻게 동작하지 ?

ChatGPT

ChatGPT

keyA와 keyB에 인덱스가 걸려있는 상황에서 keyA, keyB, keyC로 JOIN을 수행하는 경우에는 다음과 같은 과정이 일어날 것입니다:

1. 먼저 keyA와 keyB를 사용하여 조인이 이루어집니다. 이때 인덱스가 걸려있으므로 빠르게 해당 조건을 만족하는 행을 찾을 수 있습니다.
2. 그 다음으로는 keyC를 사용하여 추가적인 조인을 수행합니다. 이때는 keyC에 대한 인덱스가 있는지 여부에 따라 성능이 결정됩니다.
3. keyC에 대한 인덱스가 있는 경우, 해당 인덱스를 활용하여 빠르게 조인을 수행할 수 있습니다. 이는 조인된 결과의 크기가 크거나, keyC의 분포가 넓을 때 특히 유용합니다.
4. 하지만 keyC에 대한 인덱스가 없는 경우, 조인 시에 전체 테이블을 스캔하며 매칭되는 행을 찾아야 합니다. 이는 성능에 부담을 줄 수 있으며, 특히 큰 테이블이 포함된 경우에는 시간이 많이 소요될 수 있습니다.

따라서 keyA와 keyB에 인덱스가 있는 상황에서도 keyC를 사용하여 JOIN을 할 경우, 성능은 keyC에 대한 인덱스의 유무와 관련이 있습니다. 가능하다면 keyC에도 인덱스를 걸어 성능을 최적화할 수 있습니다

keyC에 인덱스가 걸려있지 않다면, 앞의 두 키가 걸려있다 하더라도 성능상에 문제가 있겠네 ?


맞습니다, keyC에 인덱스가 걸려있지 않은 경우에는 성능상 문제가 발생할 수 있습니다. 이는 keyC를 사용하여 조인할 때 전체 테이블을 스캔해야 하므로 성능에 부담이 될 수 있습니다.

만약 keyC에 대한 인덱스를 걸지 않은 이유가 데이터의 특성이나 사용 패턴에 따라 인덱스를 걸 필요성을 느끼지 못했거나 인덱스를 걸었을 때의 이점이 작다고 판단했다면, 다른 방법을 고려해볼 수 있습니다. 예를 들어, 조인을 수행하기 전에 필요한 데이터를 미리 필터링하거나, 효율적인 쿼리 플랜을 구성하여 조인을 최적화할 수 있습니다.

그러나 데이터셋이 크고 조인되는 테이블이 많은 경우에는 인덱스를 적절히 활용하여 성능을 최적화하는 것이 중요합니다. 따라서 가능하다면 keyC에도 인덱스를 걸어 성능을 향상시킬 수 있습니다.